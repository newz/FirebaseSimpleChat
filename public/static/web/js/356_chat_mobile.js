var lastid="";var touid="";var isopemotion=false;var isposting=false;var utime=0;var userdata={};window.onload=function(){$("#textinput").keydown(function(c){if(c.keyCode=="13"){chatPost()}});var b=$("#emotion-select");for(var a=0;a<emotionoption.length;a++){b.append('<img src="/static/images/emotion/'+emotionoption[a]+'" class="show-mini" onMouseOver="addemotion(\''+emotionoption[a]+"')\">")}};function chatInit(){$("#chatinner").html('<center><img src="/static/images/loading.gif"></center>');isinit=true;$.post("start.php",{t:new Date().getTime()},function(b){var a=$.parseJSON(b);$("#chatinner").html("");utime=a.svtime;addNewMsg(a);setInterval(chatUpdate,500)})}function toggleemotion(){if(isopemotion==true){hideemotion()}else{showemotion()}}function showemotion(){isopemotion=true;var a=$(document).width()-58;$("#emotion-wrap").css("width",a).css("marginLeft","-"+(a/2+10)+"px").show()}function hideemotion(){isopemotion=false;$("#emotion-wrap").hide()}function addemotion(a){hideemotion();var f=document.getElementById("textinput");if(typeof(f.caretPos)!="undefined"&&f.createTextRange){var e=f.caretPos;var h=e.text.length;e.text=e.text.charAt(e.text.length-1)==" "?"{e "+a+"} ":"{e "+a+"}"}else{if(typeof(f.selectionStart)!="undefined"){var b=f.value.substr(0,f.selectionStart);var g=f.value.substr(f.selectionStart,f.selectionEnd-f.selectionStart);var d=f.value.substr(f.selectionEnd);var c=f.selectionStart;var j="{e "+a+"}";f.value=b+j+d}else{f.value+="{e "+a+"}"}}}function chatUpdate(){if(isposting==true){return false}isposting=true;$.post("update.php",{id:lastid,utime:utime,t:new Date().getTime()},function(b){isposting=false;var a=$.parseJSON(b);utime=a.svtime;addNewMsg(a)}).error(function(){isposting=false})}function chatPost(){var b=$("#textinput").val();var c=new Date().getTime();var a=Math.floor(c/1000);if(b===""){return false}$("#textinput").val("").focus();$("#chatinner").append(getChatHtml({_id:"preview"+c,uid:wwwuid,touid:"",text:bbcode_parser(b),time:a},userdata,true));$.post("post.php",{message:b,touid:"",id:lastid,t:new Date().getTime()},function(d){$("#preview"+c+"_t").html(d)}).error(function(){$("#preview"+c).addClass("rowerror").attr("title","ไม่สามารถส่งได้")})}function getDate(d){var b=new Date(d*1000);var a=b.getHours();if(a<10){a="0"+a}var c=b.getMinutes();if(c<10){c="0"+c}return a+":"+c}function addNewMsg(b){if($.isEmptyObject(b.rows)){return false}var a="";userdata=b.users;$.each(b.rows,function(c,d){if(d._id>lastid){lastid=d._id;a=getChatHtml(d,b.users);$("#chatinner").append(a)}});$("body").animate({scrollTop:$("body")[0].scrollHeight},500)}function getChatHtml(c,d){var b=getDate(c.time);var a="";if(c.touid==wwwuid){a=' &nbsp;<span class="label" style="cursor: pointer;" onClick="setTouid(\''+c.uid+"')\">&#3585;&#3619;&#3632;&#3595;&#3636;&#3610;&#3585;&#3633;&#3610;&#3588;&#3640;&#3603;</span>";newwhisper=true}else{if(c.touid!=""){a=' &nbsp;<span class="label" style="cursor: pointer;" onClick="setTouid(\''+c.touid+"')\">&#3585;&#3619;&#3632;&#3595;&#3636;&#3610;&#3606;&#3638;&#3591; "+d[c.touid].name+"</span>"}}return'<div class="chatrow" id="'+c._id+'"><span style="float:right;" class="time">'+b+'</span><img src="'+d[c.uid].avatar+'" class="img-polaroid avatar-mini '+c.uid+'_av"><a href="javascript:;" class="'+c.uid+'_n">'+d[c.uid].name+"</a>"+a+'<br><span id="'+c._id+'_t">'+c.text+'</span><hr class="clearfix"></div>'}function setTouid(a){if(wwwuid==a){return false}touid=a;if(a==""){$("#whisper-name").css("color","#999").css("text-align","center").html("&#3585;&#3619;&#3632;&#3595;&#3636;&#3610;&#3585;&#3633;&#3610;&#3648;&#3614;&#3639;&#3656;&#3629;&#3609;")}else{$("#whisper-name").css("color","#333").css("text-align","left").html($("#"+a+"_wpn").html()).find("img").addClass("whisper-avatar")}}function bbcode_parser(a){a=replaceURLWithHTMLLinks(escapeHtml(a));search=new Array(/\[b\](.*?)\[\/b\]/g,/\[i\](.*?)\[\/i\]/g,/\[u\](.*?)\[\/u\]/g,/\[s\](.*?)\[\/s\]/g,/\[img\](.*?)\[\/img\]/g,/\[url\="?(.*?)"?\](.*?)\[\/url\]/g,/\[url\](.*?)\[\/url\]/g,/\[size\=(.*?)\](.*?)\[\/size\]/g,/\{e (.*?)\}/g);replace=new Array("<strong>$1</strong>","<em>$1</em>","<u>$1</u>","<strike>$1</strike>",'<img src="$1">','<a href="$1">$2</a>','<a href="$1">$1</a>','<font size="$1">$2</font>','<img src="http://chat.necz.net/static/images/emotion/$1">');for(i=0;i<search.length;i++){a=a.replace(search[i],replace[i])}return a}function escapeHtml(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function replaceURLWithHTMLLinks(b){var a=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return b.replace(a,"<a href='$1'>$1</a>")};