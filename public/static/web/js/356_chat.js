var isinit=false;var lastid="";var touid="";var disableupdate=false;var userdata=new Array();var onlineuser=new Array();var oldonlineuser=new Array();var lastupdateuser=new Array();var lastsent=0;var onlinecount=0;var linkcount=0;var newwhisper=false;var isactive;var isposting=false;var utime=0;var delay=0;var delay_allow=1000;window.onload=function(){$("#btnbb a").tooltip();$("#textinput").keydown(function(d){if(d.keyCode=="13"){chatPost()}});var c=$("#color-select");for(var a=0;a<coloroption.length;a++){c.append('<span style="background:'+coloroption[a]+";\" onClick=\"bbcode('color','"+coloroption[a]+"');\"></span>")}var b=$("#emotion-select");for(var a=0;a<emotionoption.length;a++){b.append('<img src="/static/images/emotion/'+emotionoption[a]+'" class="show-mini" onClick="addemotion(\''+emotionoption[a]+"')\">")}};$(window).focus(function(){isactive=true});$(window).blur(function(){isactive=false});function bbcode(n,e,h){var k=document.getElementById("textinput");e=typeof e!=="undefined"?e:false;h=typeof h!=="undefined"?h:false;if(typeof(k.caretPos)!="undefined"&&k.createTextRange){var j=k.caretPos;var m=j.text.length;var c="["+n+(e!==false?"="+e:"")+"]";var a="[/"+n+"]";j.text=j.text.charAt(j.text.length-1)==" "?c+j.text+a+" ":"["+n+(e!==false?"="+e:"")+"]"+j.text+"[/"+n+"]";if(m==0){j.moveStart("character",-a.length);j.moveEnd("character",-a.length);j.select()}else{k.focus(j)}}else{if(typeof(k.selectionStart)!="undefined"){var d=k.value.substr(0,k.selectionStart);var l=k.value.substr(k.selectionStart,k.selectionEnd-k.selectionStart);var g=k.value.substr(k.selectionEnd);var f=k.selectionStart;var b=k.scrollTop;var c="["+n+(e!==false?"="+e:"")+"]";var a="[/"+n+"]";if(k.setSelectionRange){if(l.length==0){if(h!==false){window[h]()}else{k.value=d+c+l+a+g;k.setSelectionRange(f+c.length,f+c.length)}}else{k.value=d+c+l+a+g;k.setSelectionRange(f,f+c.length+l.length+a.length)}k.focus()}k.scrollTop=b}else{k.value+="["+n+(e!==false?"="+e:"")+"][/"+n+"]";k.focus(k.value.length-1)}}}function addemotion(a){var f=document.getElementById("textinput");if(typeof(f.caretPos)!="undefined"&&f.createTextRange){var e=f.caretPos;var h=e.text.length;e.text=e.text.charAt(e.text.length-1)==" "?"{e "+a+"} ":"{e "+a+"}";f.focus(e)}else{if(typeof(f.selectionStart)!="undefined"){var b=f.value.substr(0,f.selectionStart);var g=f.value.substr(f.selectionStart,f.selectionEnd-f.selectionStart);var d=f.value.substr(f.selectionEnd);var c=f.selectionStart;var j="{e "+a+"}";f.value=b+j+d;f.setSelectionRange(c+j.length,c+j.length);f.focus()}else{f.value+="{e "+a+"}";f.focus(f.value.length-1)}}}function chatReload(){if(isinit===false||disableupdate===true){return false}disableupdate=true;$("#chatinner").html('<center><img src="/static/images/loading.gif"></center>');$.post("start.php",{reload:1},function(b){var a=$.parseJSON(b);$("#chatinner").html("");utime=a.svtime;lastid="";addNewMsg(a,false);updateOnline(a);disableupdate=false})}function editprofiledialog(){if(isinit===false){return false}$("#editprofiledialog").modal("show");$("#edit_sound").val(play_sound);$("#effect_types").val(effect)}function saveprofile(){$("#editprofiledialog input,#editprofiledialog select").attr("disabled","disabled");var a=$("#edit_nickname").val();var b=$("#edit_avatar").val();effect=$("#effect_types").val();play_sound=$("#edit_sound").val();$.post("savesetting.php",{nickname:a,avatar:b,sound:play_sound,effect:effect},function(c){$("#editprofiledialog").modal("hide");$("#editprofiledialog input,#editprofiledialog select").removeAttr("disabled")})}function imagedialog(){$("#imagedialog").modal("show");$("#insertimage").val("").focus()}function imageinsert(){var a=document.getElementById("textinput");$("#imagedialog").modal("hide");a.value+="[img]"+$("#insertimage").val()+"[/img]";$("#textinput").focus()}function linkdialog(){$("#linkdialog").modal("show");$("#insertlinktext").val("");$("#insertlink").val("").focus()}function linkinsert(){var a=document.getElementById("textinput");$("#linkdialog").modal("hide");var b=$("#insertlinktext").val();if(b===""){a.value+="[url]"+$("#insertlink").val()+"[/url]"}else{a.value+="[url="+$("#insertlink").val()+"]"+b+"[/url]"}$("#textinput").focus()}function chatInit(){$("#chatinner").html('<center><img src="/static/images/loading.gif"></center>');$("#online-count").removeClass("hide");isinit=true;$.post("start.php",function(b){var a=$.parseJSON(b);$("#chatinner").html("");utime=a.svtime;addNewMsg(a,false);updateOnline(a);setInterval(chatUpdate,500)})}function chatUpdate(){if(isinit===false||isposting===true||disableupdate===true){return false}isposting=true;$.post("update.php",{id:lastid,utime:utime,},function(b){isposting=false;var a=$.parseJSON(b);utime=a.svtime;addNewMsg(a,true);updateOnline(a)}).error(function(){isposting=false})}function chatPost(){var c=new Date().getTime();if(isinit===false||c-delay<delay_allow){return false}delay=c;var b=$("#textinput").val();if(b===""){return false}$("#textinput").val("").focus();var a=Math.floor(c/1000);$("#chatinner").prepend(getChatHtml({_id:"preview"+c,uid:wwwuid,touid:touid,text:bbcode_parser(b),time:a},userdata,true,true));$.post("post.php",{message:b,touid:touid,id:lastid},function(d){$("#preview"+c+"_t").html(d);$("#preview"+c+"_t > *").each(function(e){parseElement($(this))})}).error(function(){$("#preview"+c).removeClass("hide rowpreview").addClass("rowerror").attr("title","ไม่สามารถส่งได้")})}function getDate(d){var b=new Date(d*1000);var a=b.getHours();if(a<10){a="0"+a}var c=b.getMinutes();if(c<10){c="0"+c}return a+":"+c}function quotamsg(a){$("#textinput").val($("#"+a+"_t").text()+" // ").focus()}function hidemsg(a){$("#"+a).remove()}function parseElement(c){if(c.hasClass("exlink")){linkcount+=1;var e=c.attr("href");var d='<img src="http://wimg.ca/'+e+'" style="width:208px;height:142px;">';if(e.search(/youtu\.be/i)!=-1){var a=e.split("be/");d='<iframe width="208" height="142" src="http://www.youtube.com/embed/'+a[1]+'" frameborder="0"></iframe>'}if(e.search(/youtube\.com\/watch/i)!=-1){var a=e.split("v=");d='<iframe width="208" height="142" src="http://www.youtube.com/embed/'+a[1]+'" frameborder="0"></iframe>'}c.attr("target","_blank").before('<span class="hide">[url='+e+"]</span>").after('<span class="hide">[/url]</span>&nbsp;<i class="icon-share preview" id="link_'+linkcount+'"></i>').next().next().tooltip({title:"Preview"}).popover({title:'Preview <a class="close" href="javascript:;" onclick="$(\'#link_'+linkcount+"').popover('hide');\">&times;</a>",placement:"bottom",content:d})}else{if(c.hasClass("eximg")){var g=c.attr("src");var f="";if(g.search(/(imageshack\.us\/img|sankakustatic\.com\/data|sankakucomplex\.com\/wp-content)/i)!=-1){c.attr("src","https://images2-focus-opensocial.googleusercontent.com/gadgets/proxy?url="+g+"&container=focus&gadget=a&no_expand=1&resize_h=0");if(parseInt(c.css("width"))>0&&parseInt(c.css("height"))>0){f="="+parseInt(c.css("width"))+","+parseInt(c.css("height"))}}c.after('<span class="hide">[img'+f+"]"+g+"[/img]</span>")}else{if(c.hasClass("emo")){var g=c.attr("src");var h=g.split("/static/images/emotion/");h=h[1].split('"');c.after('<span class="hide">{e '+h[0]+"}</span>")}else{if(c.hasClass("spoil")){c.before('<span class="hide">[spoiler]</span>').after('<span class="hide">[/spoiler]</span>')}else{if(c.hasClass("mp3")){var g=c.attr("flashvars");var b=g.split('flashvars="file=');b=b[1].split("&type=mp3");c.after('<span class="hide">[mp3]'+b+"[/mp3]</span>")}else{if(c.hasClass("spoil")){c.before('<span class="hide">[spoiler]</span>').after('<span class="hide">[/spoiler]</span>')}}}}}}}function addNewMsg(d,f){if($.isEmptyObject(d.rows)){return false}var e="";var a="";var b="";var c="";$.each(d.rows,function(g,h){if(h._id>lastid){lastid=h._id;c=getChatHtml(h,d.users,f,false);$("#chatinner").prepend(c)}});$("#chatinner div.new span > *").each(function(g){parseElement($(this))});$("#chatinner div.new").removeClass("new");if(isactive==false&&newwhisper&&f&&play_sound==1){playSound("msn")}if(isactive==false&&f&&play_sound==2){playSound("msn")}if(newwhisper){newwhisper=false}}function updateOnline(c){onlinecount=0;var b="";var a="";updateChatUser(c.users);onlineuser=new Array();$.each(c.online,function(e,f){lastupdateuser[f.uid]={url:c.users[f.uid].url,last:f.last};onlinecount+=1;onlineuser.push(f.uid);if($("#"+f.uid+"_o").length==0){b+=getOnlineHtml(f,c.users);if(f.uid!=wwwuid){a+=getWhisperHtml(f,c.users)}}});var d=$.grep(oldonlineuser,function(e){return $.inArray(e,onlineuser)==-1});$.each(d,function(e){$("#"+d[e]+"_o, #"+d[e]+"_wpl").remove();if(touid==d[e]){setTouid("")}});oldonlineuser=onlineuser;$("#online-count").html(onlinecount);$("#online-list").append(b);$("#whisper-list").append(a);if(onlinecount>7){$("#whisper-list").css("overflow-y","scroll")}else{$("#whisper-list").css("overflow-y","hidden")}if(onlinecount>12){$("#online-list").css("overflow-y","scroll")}else{$("#online-list").css("overflow-y","hidden")}$("#online-list li.new").popover({placement:"left"}).draggable({appendTo:"body",helper:"clone"}).removeClass("new")}function updateChatUser(a){$.each(a,function(b,c){if(userdata.hasOwnProperty(b)){if(userdata[b].avatar!=c.avatar){$("."+b+"_av").attr("src",c.avatar);userdata[b].avatar=c.avatar}if(userdata[b].name!=c.name){$("."+b+"_n").html(c.name);userdata[b].name=c.name}if(userdata[b].device!=c.device){userdata[b].name=c.device}}else{userdata[b]=c}})}function setTouid(a){if(wwwuid==a||(a!=""&&$("#"+a+"_wpn").length==0)){return false}touid=a;if(a==""){$("#whisper-name").css("color","#999").css("text-align","center").html("&#3585;&#3619;&#3632;&#3595;&#3636;&#3610;&#3585;&#3633;&#3610;&#3648;&#3614;&#3639;&#3656;&#3629;&#3609;")}else{$("#whisper-name").css("color","#333").css("text-align","left").html($("#"+a+"_wpn").html()).find("img").addClass("whisper-avatar")}}function getChatHtml(j,b,e,h){var c=getDate(j.time);var a="";var f="";var d="";var g="";if(j.touid==wwwuid){if(wwwuid=="50810a85e6c2d1e670000000"||wwwuid=="50806aa0e6c2d1fe1f000000"){a=' &nbsp;<span class="badge" style="cursor: pointer;" onClick="setTouid(\''+j.touid+"')\">&#3585;&#3619;&#3632;&#3595;&#3636;&#3610;&#3606;&#3638;&#3591; "+b[j.touid].name+"</span>"}a=' &nbsp;<span class="badge" style="cursor: pointer;" onClick="setTouid(\''+j.uid+"')\">&#3585;&#3619;&#3632;&#3595;&#3636;&#3610;&#3585;&#3633;&#3610;&#3588;&#3640;&#3603;</span>";newwhisper=true}else{if(j.touid!=""){a=' &nbsp;<span class="badge" style="cursor: pointer;" onClick="setTouid(\''+j.touid+"')\">&#3585;&#3619;&#3632;&#3595;&#3636;&#3610;&#3606;&#3638;&#3591; "+b[j.touid].name+"</span>"}}if(a==""){f="#DDD";d="#FFF";g="transparent"}else{f="#D8E0E6";d="#EDF8FF";g="#EDF8FF"}return'<div class="chatrow hover-grp '+(h==true?"rowpreview":"new")+(effect=="normal"?"":" hide")+'" id="'+j._id+'"><span class="show-hover"><a href="javascript:;" onClick="quotamsg(\''+j._id+'\')">&#3629;&#3657;&#3634;&#3591;&#3629;&#3636;&#3591;</a> <a href="javascript:;" onClick="hidemsg(\''+j._id+'\')">&#3595;&#3656;&#3629;&#3609;</a></span><img src="'+b[j.uid].avatar+'" class="img-polaroid avatar-mini '+j.uid+'_av"><a href="'+b[j.uid].url+'" class="'+j.uid+'_n">'+b[j.uid].name+'</a>&nbsp;<span class="time">('+c+")</span>"+a+'<br><span id="'+j._id+'_t">'+j.text+'</span><hr class="clearfix"><script>animaterow("'+j._id+'",'+(e==true?"true":"false")+",'"+f+"','"+d+"','"+g+"');<\/script></div>"}function getOnlineHtml(b,c){var a=getDate(b.last);return"<li onMouseOver=\"popoverUpdate('"+b.uid+'\')" class="new" id="'+b.uid+'_o" rel="popover" title="User Profile &lt;a class=&quot;close&quot; href=&quot;javascript:;&quot; onclick=&quot;$(\'#'+b.uid+'_o\').popover(\'hide\');&quot;&gt;&times;&lt;/a&gt;" data-content=""><a href="javascript:;"><img src="'+c[b.uid].avatar+'" class="avatar-online '+b.uid+'_av"> <span class="'+b.uid+'_n">'+c[b.uid].name+"</span></a></li>"}function getWhisperHtml(a,b){return'<li id="'+a.uid+'_wpl"><a href="javascript:;" onclick="setTouid(\''+a.uid+'\');" id="'+a.uid+'_wpn"><img src="'+b[a.uid].avatar+'" class="'+a.uid+'_av"> <span class="'+a.uid+'_n">'+b[a.uid].name+"</span></a></li>"}function popoverUpdate(a){$("#"+a+"_o").attr("data-content",'<div style="height:90px;"><img src="'+userdata[a].avatar+'" class="avatar-pop img-polaroid">Update: '+getDate(lastupdateuser[a].last)+'<br><i class="icon-share"></i> <a href="'+lastupdateuser[a].url+'" target="_blank">Homepage</a><br><i class="icon-signal"></i> <span style="text-transform:capitalize;">'+userdata[a].device+"</span>"+(wwwuid==a?"":'<br><i class="icon-comment"></i> <a href="javascript:;" onclick="setTouid(\''+a+'\')" target="_blank">Whisper</a>')+"</div>")}function playSound(a){$("#play-sound").append('<embed name="soundplayer" width="0" height="0" src="/static/flash/player.swf" flashvars="sFile=static/sound/'+a+'.mp3" menu="false" allowscriptaccess="sameDomain" swliveconnect="true" type="application/x-shockwave-flash"></embed>')}function animaterow(f,b,e,a,d){if(b==true){if(effect=="normal"){$("#"+f).css("backgroundColor",e).animate({backgroundColor:a},500,function(){$(this).css("backgroundColor",d)})}else{var c={};if(effect==="scale"){c={percent:100}}else{if(effect==="size"){c={to:{width:280,height:185}}}}$("#"+f).css("backgroundColor",d);$("#"+f).show(effect,c,500)}}else{$("#"+f).removeClass("hide");$("#"+f).css("backgroundColor",d)}}function bbcode_parser(a){a=replaceURLWithHTMLLinks(escapeHtml(a));search=new Array(/\[b\](.*?)\[\/b\]/g,/\[i\](.*?)\[\/i\]/g,/\[u\](.*?)\[\/u\]/g,/\[s\](.*?)\[\/s\]/g,/\[img\](.*?)\[\/img\]/g,/\[url\="?(.*?)"?\](.*?)\[\/url\]/g,/\[url\](.*?)\[\/url\]/g,/\[size\=(.*?)\](.*?)\[\/size\]/g,/\{e (.*?)\}/g);replace=new Array("<strong>$1</strong>","<em>$1</em>","<u>$1</u>","<strike>$1</strike>",'<img src="$1">','<a href="$1">$2</a>','<a href="$1">$1</a>','<font size="$1">$2</font>','<img src="http://chat.necz.net/static/images/emotion/$1">');for(i=0;i<search.length;i++){a=a.replace(search[i],replace[i])}return a}function escapeHtml(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function replaceURLWithHTMLLinks(b){var a=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return b.replace(a,"<a href='$1'>$1</a>")};